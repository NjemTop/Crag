{% extends 'main/base.html' %}
{% load custom_tags %}

{% block title %}
    Создать клиента
{% endblock %}

{% block content %}
    <form method="post" class="needs-validation">
        {% csrf_token %}
        <div class="mb-3">
            <label for="client_name" class="form-label">Наименование клиента <span class="text-danger">*</span></label>
            {{ form_client.client_name|add_class:'form-control' }}
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="manager" class="form-label">Менеджер <span class="text-danger">*</span></label>
                {{ servise_form.manager|add_class:'form-control' }}
            </div>
            <div class="col-md-6">
                <label for="service_pack" class="form-label">Сервис план <span class="text-danger">*</span></label>
                {{ servise_form.service_pack|add_class:'form-control' }}
            </div>
        </div>
        <div class="mb-3">
            <label for="loyal" class="form-label">Лояльность</label>
            {{ servise_form.loyal|add_class:'form-control' }}
        </div>
        <hr>
        <div class="mb-3">
            <label class="form-label">Контакты клиента</label>
            <div id="contact_form_set">
                {{ contact_formset.management_form }}
                {% for form in contact_formset %}
                    <div class="contact-form mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="{{ form.prefix }}-contact_name">ФИО <span class="text-danger">*</span></label>
                                {{ form.contact_name|add_class:'form-control' }}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.prefix }}-contact_position">Должность <span class="text-danger">*</span></label>
                                {{ form.contact_position|add_class:'form-control' }}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.prefix }}-contact_email">Почта <span class="text-danger">*</span></label>
                                {{ form.contact_email|add_class:'form-control' }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="{{ form.prefix }}-notification_update">Отправка рассылки</label>
                                {{ form.notification_update|add_class:'form-control' }}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.prefix }}-contact_notes">Заметки</label>
                                {{ form.contact_notes|add_class:'form-control' }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add_contact" class="btn btn-primary mt-2">Добавить контакт</button>
        </div>
        <button type="submit" class="btn btn-success">Добавить</button>
        <span>{{ error }}</span>
    </form>

    <script>
        var contactFormCount = {{ contact_formset.total_form_count }};
        var contactFormMaxCount = {{ contact_formset.max_num }};

        document.getElementById('add_contact').addEventListener('click', function () {
            if (contactFormCount < contactFormMaxCount) {
                var formSet = document.getElementById('contact_form_set');
                var newForm = document.createElement('div');
                newForm.className = 'contact-form mb-3';
                newForm.innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            <label for="id_contacts-${contactFormCount}-contact_name">ФИО <span class="text-danger">*</span></label>
                            <input type="text" name="contacts-${contactFormCount}-contact_name" id="id_contacts-${contactFormCount}-contact_name" required class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label for="id_contacts-${contactFormCount}-contact_position">Должность <span class="text-danger">*</span></label>
                            <input type="text" name="contacts-${contactFormCount}-contact_position" id="id_contacts-${contactFormCount}-contact_position" required class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label for="id_contacts-${contactFormCount}-contact_email">Почта <span class="text-danger">*</span></label>
                            <input type="email" name="contacts-${contactFormCount}-contact_email" id="id_contacts-${contactFormCount}-contact_email" required class="form-control">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="id_contacts-${contactFormCount}-notification_update">Отправка рассылки</label>
                            <input type="text" name="contacts-${contactFormCount}-notification_update" id="id_contacts-${contactFormCount}-notification_update" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="id_contacts-${contactFormCount}-contact_notes">Заметки</label>
                            <textarea name="contacts-${contactFormCount}-contact_notes" id="id_contacts-${contactFormCount}-contact_notes" class="form-control"></textarea>
                        </div>
                    </div>
                `;
                formSet.appendChild(newForm);
                contactFormCount++;
            }
        });
    </script>
{% endblock %}
